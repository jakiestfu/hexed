import { execSync } from "child_process"
import { mkdir, readFile, rm, writeFile } from "fs/promises"
import { tmpdir } from "os"
import { join } from "path"
import { compile } from "json-schema-to-typescript"

import { ksyDir } from "./common.js"

const repoUrl = "https://github.com/kaitai-io/ksy_schema.git"
const schemaFileName = "ksy_schema.json"
const outputFileName = "types.ts"

async function generateKsySchemaTypes() {
  const tempDir = join(tmpdir(), `ksy_schema_${Date.now()}`)
  const clonedRepoDir = join(tempDir, "ksy_schema")
  const schemaFilePath = join(clonedRepoDir, schemaFileName)
  const outputPath = join(ksyDir, outputFileName)
  let hadError = false

  // ANSI escape codes for styling
  const dim = "\x1b[2m"
  const reset = "\x1b[0m"

  try {
    console.log("ðŸ“ Generating schema types...")
    console.log(`${dim}  Cloning repository...${reset}`)
    execSync(`git clone --depth 1 ${repoUrl} "${clonedRepoDir}"`, {
      stdio: "ignore"
    })

    console.log(`${dim}  Reading schema file...${reset}`)
    const schemaContent = await readFile(schemaFilePath, "utf-8")
    const schema = JSON.parse(schemaContent)

    console.log(`${dim}  Converting to TypeScript types...${reset}`)
    const types = await compile(schema, "KsySchema", {
      bannerComment: `// @ts-nocheck
/**
 * This file was auto-generated from the KSY schema specification.
 * Do not edit this file directly. Run 'pnpm generate:schema-types' to regenerate.
 */`,
      style: {
        singleQuote: false,
        semi: true,
        tabWidth: 2,
        trailingComma: "es5"
      }
    })

    await mkdir(ksyDir, { recursive: true })
    await writeFile(outputPath, types, "utf-8")

    console.log(`âœ“ Generated TypeScript types`)
    console.log(`âœ“ Written to ${outputPath}`)
  } catch (error) {
    console.error("Error generating KSY schema types:", error)
    hadError = true
  } finally {
    // Always clean up temp directory, even on failure
    try {
      const dim = "\x1b[2m"
      const reset = "\x1b[0m"
      console.log(`${dim}  Cleaning up...${reset}`)
      await rm(tempDir, { recursive: true, force: true })
    } catch (cleanupError) {
      // Ignore errors if directory doesn't exist (ENOENT)
      if (cleanupError.code !== "ENOENT") {
        console.error(
          `Warning: Failed to clean up temp directory ${tempDir}:`,
          cleanupError.message
        )
      }
    }

    // Exit with error code if there was an error
    if (hadError) {
      process.exit(1)
    }
  }
}

generateKsySchemaTypes().catch((error) => {
  console.error("Fatal error:", error)
  process.exit(1)
})
