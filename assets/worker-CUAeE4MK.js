var N=Object.defineProperty;var P=(e,t,n)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var C=(e,t,n)=>P(e,typeof t!="symbol"?t+"":t,n);function z(e){return e>=32&&e<=126}function v(e,t){const n=[];let r=-1,s=0;for(let o=0;o<e.length;o++){const i=e[o];if(z(i))r===-1?(r=o,s=1):s++;else{if(r!==-1&&s>=t){const c=String.fromCharCode(...Array.from(e.slice(r,r+s)));n.push({offset:r,length:s,encoding:"ascii",text:c})}r=-1,s=0}}if(r!==-1&&s>=t){const o=String.fromCharCode(...Array.from(e.slice(r,r+s)));n.push({offset:r,length:s,encoding:"ascii",text:o})}return n}function D(e,t){if(t>=e.length)return{valid:!1,length:0,char:null};const n=e[t];if(n<128)return z(n)?{valid:!0,length:1,char:String.fromCharCode(n)}:{valid:!1,length:1,char:null};let r=0;if((n&224)===192)r=2;else if((n&240)===224)r=3;else if((n&248)===240)r=4;else return{valid:!1,length:1,char:null};if(t+r>e.length)return{valid:!1,length:0,char:null};try{const s=new TextDecoder("utf-8",{fatal:!0}),o=e.slice(t,t+r),i=s.decode(o),c=i.codePointAt(0);return c!==void 0&&c>=32&&c!==127?{valid:!0,length:r,char:i}:{valid:!1,length:r,char:null}}catch{return{valid:!1,length:r,char:null}}}function L(e,t){const n=[];let r=-1,s=0,o=0;for(let i=0;i<e.length;){const c=D(e,i);if(c.valid&&c.char)r===-1?(r=i,s=c.length,o=1):(s+=c.length,o++),i+=c.length;else{if(r!==-1&&o>=t)try{const d=new TextDecoder("utf-8",{fatal:!0}).decode(e.slice(r,r+s));n.push({offset:r,length:s,encoding:"utf8",text:d})}catch{}r=-1,s=0,o=0,i+=c.length||1}}if(r!==-1&&o>=t)try{const c=new TextDecoder("utf-8",{fatal:!0}).decode(e.slice(r,r+s));n.push({offset:r,length:s,encoding:"utf8",text:c})}catch{}return n}function A(e,t,n){return t+2>e.length?{value:null,error:"Insufficient bytes"}:{value:n?e[t]|e[t+1]<<8:e[t]<<8|e[t+1],error:null}}function U(e){return e===0?!1:e>=32&&e<55296?e!==127:e>=55296&&e<=57343?!1:e>=57344&&e<=65533}function _(e,t,n){const r=[];let s=-1,o=0,i=0;for(let c=0;c<e.length-1;c+=2){const l=A(e,c,n);if(l.error)break;const d=l.value;if(d===0){if(s!==-1&&i>=t)try{const a=new TextDecoder(n?"utf-16le":"utf-16be",{fatal:!0}).decode(e.slice(s,s+o));r.push({offset:s,length:o,encoding:n?"utf16le":"utf16be",text:a})}catch{}s=-1,o=0,i=0;continue}if(d>=55296&&d<=56319){if(c+4>e.length){if(s!==-1&&i>=t)try{const g=new TextDecoder(n?"utf-16le":"utf-16be",{fatal:!0}).decode(e.slice(s,s+o));r.push({offset:s,length:o,encoding:n?"utf16le":"utf16be",text:g})}catch{}s=-1,o=0,i=0;break}const y=A(e,c+2,n);if(y.error)break;const a=y.value;if(a>=56320&&a<=57343){s===-1?(s=c,o=4,i=1):(o+=4,i++),c+=2;continue}}if(U(d))s===-1?(s=c,o=2,i=1):(o+=2,i++);else{if(s!==-1&&i>=t)try{const a=new TextDecoder(n?"utf-16le":"utf-16be",{fatal:!0}).decode(e.slice(s,s+o));r.push({offset:s,length:o,encoding:n?"utf16le":"utf16be",text:a})}catch{}s=-1,o=0,i=0}}if(s!==-1&&i>=t)try{const l=new TextDecoder(n?"utf-16le":"utf-16be",{fatal:!0}).decode(e.slice(s,s+o));r.push({offset:s,length:o,encoding:n?"utf16le":"utf16be",text:l})}catch{}return r}function k(e,t,n){const r=[];let s=-1,o=0,i=0;for(let c=0;c<e.length-3;c+=4){const l=e[c],d=e[c+1],y=e[c+2],a=e[c+3],u=n?l|d<<8|y<<16|a<<24:l<<24|d<<16|y<<8|a;if(u===0){if(s!==-1&&i>=t)try{const g=e.slice(s,s+o),m=String.fromCodePoint(...Array.from({length:o/4},(f,w)=>{const h=s+w*4,F=g[h],M=g[h+1],R=g[h+2],S=g[h+3];return n?F|M<<8|R<<16|S<<24:F<<24|M<<16|R<<8|S}));r.push({offset:s,length:o,encoding:n?"utf32le":"utf32be",text:m})}catch{}s=-1,o=0,i=0;continue}if(u>=32&&u<=1114111&&(u<55296||u>57343)&&u!==65534&&u!==65535)s===-1?(s=c,o=4,i=1):(o+=4,i++);else{if(s!==-1&&i>=t)try{const g=e.slice(s,s+o),m=String.fromCodePoint(...Array.from({length:o/4},(f,w)=>{const h=s+w*4,F=g[h],M=g[h+1],R=g[h+2],S=g[h+3];return n?F|M<<8|R<<16|S<<24:F<<24|M<<16|R<<8|S}));r.push({offset:s,length:o,encoding:n?"utf32le":"utf32be",text:m})}catch{}s=-1,o=0,i=0}}if(s!==-1&&i>=t)try{const c=e.slice(s,s+o),l=String.fromCodePoint(...Array.from({length:o/4},(d,y)=>{const a=s+y*4,u=c[a],g=c[a+1],m=c[a+2],f=c[a+3];return n?u|g<<8|m<<16|f<<24:u<<24|g<<16|m<<8|f}));r.push({offset:s,length:o,encoding:n?"utf32le":"utf32be",text:l})}catch{}return r}function B(e,t={}){const n=t.minLength??4;switch(t.encoding??"ascii"){case"ascii":return v(e,n);case"utf8":return L(e,n);case"utf16le":return _(e,n,!0);case"utf16be":return _(e,n,!1);case"utf32le":return k(e,n,!0);case"utf32be":return k(e,n,!1);default:return v(e,n)}}function G(){return!1}function H(e){const t=G(),n=`[${e}]`;return{log:(...r)=>{t&&console.log(n,...r)}}}class V{constructor(){C(this,"handles",new Map)}async openFile(t,n){const r=await n.getFile(),s={handle:n,size:r.size,lastAccessed:Date.now()};this.handles.set(t,s)}hasFile(t){return this.handles.has(t)}async getFileSize(t){const n=this.handles.get(t);if(!n)throw new Error(`File ${t} is not open`);const r=await n.handle.getFile();return n.size=r.size,n.lastAccessed=Date.now(),r.size}async readByteRange(t,n,r){const s=this.handles.get(t);if(!s)throw new Error(`File ${t} is not open`);const o=await s.handle.getFile(),i=o.size,c=Math.max(0,Math.min(n,i)),l=r>=i?i:Math.max(c,Math.min(r,i));if(c>=i)return new Uint8Array(0);const y=await o.slice(c,l).arrayBuffer(),a=new Uint8Array(y);return s.lastAccessed=Date.now(),s.size=i,a}closeFile(t){this.handles.delete(t)}closeAll(){this.handles.clear()}getOpenFileIds(){return Array.from(this.handles.keys())}getFileInfo(t){return this.handles.get(t)}}const p=H("worker"),E={handleManager:new V},O=1024*1024;function $(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function I(e){try{self.postMessage(e)}catch(t){console.error("Error sending response:",t)}}function T(e){try{self.postMessage(e)}catch(t){console.error("Error sending progress event:",t)}}function Q(e){try{self.postMessage(e)}catch(t){console.error("Error sending search match event:",t)}}function b(e,t){p.log("Error:",e,t?`(request: ${t})`:"");const n={id:$(),type:"ERROR",error:e,originalMessageId:t};I(n)}async function W(e){p.log(`Opening file: ${e.fileId} (request: ${e.id})`);try{await E.handleManager.openFile(e.fileId,e.handle),p.log(`File opened successfully: ${e.fileId}`);const t={id:e.id,type:"CONNECTED"};I(t)}catch(t){b(t instanceof Error?t.message:"Failed to open file",e.id)}}async function Z(e){p.log(`Streaming file: ${e.fileId} (request: ${e.id})`);try{if(!E.handleManager.hasFile(e.fileId)){b(`File ${e.fileId} is not open`,e.id);return}const t=await E.handleManager.getFileSize(e.fileId);let n=0;for(;n<t;){const s=Math.min(n+O,t);await E.handleManager.readByteRange(e.fileId,n,s),n=s;const o=Math.min(100,Math.round(n/t*100)),i={id:$(),type:"PROGRESS_EVENT",requestId:e.id,progress:o,bytesRead:n,totalBytes:t};T(i),await new Promise(c=>setTimeout(c,0))}p.log(`File streamed successfully: ${e.fileId}, ${n} bytes`);const r={id:e.id,type:"STREAM_FILE_RESPONSE",fileId:e.fileId};I(r)}catch(t){b(t instanceof Error?t.message:"Failed to stream file",e.id)}}async function j(e){p.log(`Searching file: ${e.fileId} (request: ${e.id})`);try{if(!E.handleManager.hasFile(e.fileId)){b(`File ${e.fileId} is not open`,e.id);return}const t=await E.handleManager.getFileSize(e.fileId),n=e.startOffset??0,r=e.endOffset??t,s=r-n,o=e.pattern,i=[];let c=n,l=0;for(;c<r;){const y=Math.min(c+O+o.length-1,r),a=await E.handleManager.readByteRange(e.fileId,c,y),u=[];for(let f=0;f<=a.length-o.length;f++){let w=!0;for(let h=0;h<o.length;h++)if(a[f+h]!==o[h]){w=!1;break}if(w){const h={offset:c+f,length:o.length};i.push(h),u.push(h)}}if(u.length>0){const f={id:$(),type:"SEARCH_MATCH_EVENT",requestId:e.id,matches:u};Q(f)}l=Math.min(y-n,s),c=y-o.length+1;const g=Math.min(100,Math.round(l/s*100)),m={id:$(),type:"PROGRESS_EVENT",requestId:e.id,progress:g,bytesRead:l,totalBytes:s};T(m),await new Promise(f=>setTimeout(f,0))}p.log(`Search completed: ${e.fileId}, found ${i.length} matches`);const d={id:e.id,type:"SEARCH_RESPONSE",fileId:e.fileId,matches:i};I(d)}catch(t){b(t instanceof Error?t.message:"Failed to search file",e.id)}}function K(e){switch(e){case"ascii":return 0;case"utf8":return 3;case"utf16le":case"utf16be":return 1;case"utf32le":case"utf32be":return 3;default:return 3}}async function J(e){p.log(`Extracting strings from file: ${e.fileId} (request: ${e.id})`);try{if(!E.handleManager.hasFile(e.fileId)){b(`File ${e.fileId} is not open`,e.id);return}const t=await E.handleManager.getFileSize(e.fileId),n=e.startOffset??0,s=(e.endOffset??t)-n,o=e.encoding??"ascii",i=K(o),c=[];let l=new Uint8Array(0),d=0;for(;d<s;){const a=n+d,u=Math.min(a+O,n+s),g=await E.handleManager.readByteRange(e.fileId,a,u),m=l.length+g.length,f=new Uint8Array(m);f.set(l,0),f.set(g,l.length);const w=B(f,{minLength:e.minLength,encoding:e.encoding});for(const S of w)if(S.offset<l.length){if(S.offset+S.length<=l.length)continue;continue}else{const x=a+(S.offset-l.length);c.push({...S,offset:x})}const h=Math.min(i,f.length);h>0?l=f.slice(f.length-h):l=new Uint8Array(0);const F=u-a;d+=F;const M=Math.min(100,Math.round(d/s*100)),R={id:$(),type:"PROGRESS_EVENT",requestId:e.id,progress:M,bytesRead:d,totalBytes:s};T(R),await new Promise(S=>setTimeout(S,0))}p.log(`Strings extraction completed: ${e.fileId}, found ${c.length} matches`);const y={id:e.id,type:"STRINGS_RESPONSE",fileId:e.fileId,matches:c};I(y)}catch(t){b(t instanceof Error?t.message:"Failed to extract strings",e.id)}}async function X(e){p.log(`Getting file size: ${e.fileId} (request: ${e.id})`);try{const t=await E.handleManager.getFileSize(e.fileId);p.log(`File size: ${e.fileId} = ${t} bytes`);const n={id:e.id,type:"FILE_SIZE_RESPONSE",fileId:e.fileId,size:t};I(n)}catch(t){b(t instanceof Error?t.message:"Failed to get file size",e.id)}}function Y(e){p.log(`Closing file: ${e.fileId} (request: ${e.id})`);try{E.handleManager.closeFile(e.fileId),p.log(`File closed successfully: ${e.fileId}`);const t={id:e.id,type:"CONNECTED"};I(t)}catch(t){b(t instanceof Error?t.message:"Failed to close file",e.id)}}async function q(e){switch(e.type){case"OPEN_FILE":await W(e);break;case"GET_FILE_SIZE":await X(e);break;case"CLOSE_FILE":Y(e);break;case"STREAM_FILE_REQUEST":await Z(e);break;case"SEARCH_REQUEST":await j(e);break;case"STRINGS_REQUEST":await J(e);break;default:const t=e;b(`Unknown message type: ${t.type}`,t.id)}}if(typeof self<"u"){p.log("Worker initialized");const e={id:$(),type:"CONNECTED"};I(e),self.onmessage=t=>{const n=t.data;n.type==="CONNECTED"||n.type.startsWith("RESPONSE")||n.type==="PROGRESS_EVENT"||n.type==="SEARCH_MATCH_EVENT"||(p.log(`Received request: ${n.type} (id: ${n.id})`),q(n).catch(r=>{p.log("Unhandled error in request handler:",r),b("Internal error processing request",n.id)}))},self.onerror=t=>{p.log("Worker error:",t)}}
