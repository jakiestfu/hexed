import{k as y}from"./index-DZ3xxA7Z.js";var k=Object.getOwnPropertyNames,O=(f,r)=>function(){return r||(0,f[k(f)[0]])((r={exports:{}}).exports,r),r.exports},z=O({"<stdin>"(f){(function(r,_){typeof define=="function"&&define.amd?define(["exports","kaitai-struct/KaitaiStream"],_):typeof f=="object"&&f!==null&&typeof f.nodeType!="number"?_(f,y.KaitaiStream):_(r.Vdi||(r.Vdi={}),r.KaitaiStream)})(typeof self<"u"?self:f,function(r,_){var c=(function(){h.ImageType=Object.freeze({DYNAMIC:1,STATIC:2,UNDO:3,DIFF:4,1:"DYNAMIC",2:"STATIC",3:"UNDO",4:"DIFF"});function h(i,d,t){this._io=i,this._parent=d,this._root=t||this,this._debug={},this._read()}h.prototype._read=function(){this._debug.header={start:this._io.pos,ioOffset:this._io.byteOffset},this.header=new m(this._io,this,this._root),this._debug.header.end=this._io.pos};var l=h.BlocksMap=(function(){function i(t,n,e){this._io=t,this._parent=n,this._root=e,this._debug={},this._read()}i.prototype._read=function(){this._debug.index={start:this._io.pos,ioOffset:this._io.byteOffset},this._debug.index.arr=[],this.index=[];for(var t=0;t<this._root.header.headerMain.blocksInImage;t++)this._debug.index.arr[t]={start:this._io.pos,ioOffset:this._io.byteOffset},this.index.push(new d(this._io,this,this._root)),this._debug.index.arr[t].end=this._io.pos;this._debug.index.end=this._io.pos};var d=i.BlockIndex=(function(){function t(n,e,s){this._io=n,this._parent=e,this._root=s,this._debug={},this._read()}return t.prototype._read=function(){this._debug.index={start:this._io.pos,ioOffset:this._io.byteOffset},this.index=this._io.readU4le(),this._debug.index.end=this._io.pos},Object.defineProperty(t.prototype,"block",{get:function(){return this._m_block!==void 0?this._m_block:(this.isAllocated&&(this._debug._m_block={},this._m_block=this._root.disk.blocks[this.index]),this._m_block)}}),Object.defineProperty(t.prototype,"isAllocated",{get:function(){return this._m_isAllocated!==void 0?this._m_isAllocated:(this._debug._m_isAllocated={},this._m_isAllocated=this.index<this._root.blockDiscarded,this._m_isAllocated)}}),t})();return i})(),g=h.Disk=(function(){function i(t,n,e){this._io=t,this._parent=n,this._root=e,this._debug={},this._read()}i.prototype._read=function(){this._debug.blocks={start:this._io.pos,ioOffset:this._io.byteOffset},this._debug.blocks.arr=[],this.blocks=[];for(var t=0;t<this._root.header.headerMain.blocksInImage;t++)this._debug.blocks.arr[t]={start:this._io.pos,ioOffset:this._io.byteOffset},this.blocks.push(new d(this._io,this,this._root)),this._debug.blocks.arr[t].end=this._io.pos;this._debug.blocks.end=this._io.pos};var d=i.Block=(function(){function t(e,s,a){this._io=e,this._parent=s,this._root=a,this._debug={},this._read()}t.prototype._read=function(){for(this._debug.metadata={start:this._io.pos,ioOffset:this._io.byteOffset},this.metadata=this._io.readBytes(this._root.header.headerMain.blockMetadataSize),this._debug.metadata.end=this._io.pos,this._debug.data={start:this._io.pos,ioOffset:this._io.byteOffset},this._debug.data.arr=[],this._raw_data=[],this.data=[];!this._io.isEof();){this._debug.data.arr[this.data.length]={start:this._io.pos,ioOffset:this._io.byteOffset},this._raw_data.push(this._io.readBytes(this._root.header.headerMain.blockDataSize));var e=new _(this._raw_data[this._raw_data.length-1]);this.data.push(new n(e,this,this._root)),this._debug.data.arr[this.data.length-1].end=this._io.pos}this._debug.data.end=this._io.pos};var n=t.Sector=(function(){function e(s,a,o){this._io=s,this._parent=a,this._root=o,this._debug={},this._read()}return e.prototype._read=function(){this._debug.data={start:this._io.pos,ioOffset:this._io.byteOffset},this.data=this._io.readBytes(this._root.header.headerMain.geometry.sectorSize),this._debug.data.end=this._io.pos},e})();return t})();return i})(),m=h.Header=(function(){function i(e,s,a){this._io=e,this._parent=s,this._root=a,this._debug={},this._read()}i.prototype._read=function(){if(this._debug.text={start:this._io.pos,ioOffset:this._io.byteOffset},this.text=_.bytesToStr(this._io.readBytes(64),"UTF-8"),this._debug.text.end=this._io.pos,this._debug.signature={start:this._io.pos,ioOffset:this._io.byteOffset},this.signature=this._io.readBytes(4),this._debug.signature.end=this._io.pos,_.byteArrayCompare(this.signature,new Uint8Array([127,16,218,190]))!=0){var e=new _.ValidationNotEqualError(new Uint8Array([127,16,218,190]),this.signature,this._io,"/types/header/seq/1");throw this._debug.signature.validationError=e,e}this._debug.version={start:this._io.pos,ioOffset:this._io.byteOffset},this.version=new n(this._io,this,this._root),this._debug.version.end=this._io.pos,this.subheaderSizeIsDynamic&&(this._debug.headerSizeOptional={start:this._io.pos,ioOffset:this._io.byteOffset},this.headerSizeOptional=this._io.readU4le(),this._debug.headerSizeOptional.end=this._io.pos),this._debug.headerMain={start:this._io.pos,ioOffset:this._io.byteOffset},this._raw_headerMain=this._io.readBytes(this.headerSize);var s=new _(this._raw_headerMain);this.headerMain=new d(s,this,this._root),this._debug.headerMain.end=this._io.pos};var d=i.HeaderMain=(function(){function e(o,u,b){this._io=o,this._parent=u,this._root=b,this._debug={},this._read()}e.prototype._read=function(){this._debug.imageType={start:this._io.pos,ioOffset:this._io.byteOffset,enumName:"Vdi.ImageType"},this.imageType=this._io.readU4le(),this._debug.imageType.end=this._io.pos,this._debug.imageFlags={start:this._io.pos,ioOffset:this._io.byteOffset},this.imageFlags=new s(this._io,this,this._root),this._debug.imageFlags.end=this._io.pos,this._debug.description={start:this._io.pos,ioOffset:this._io.byteOffset},this.description=_.bytesToStr(this._io.readBytes(256),"UTF-8"),this._debug.description.end=this._io.pos,this._parent.version.major>=1&&(this._debug.blocksMapOffset={start:this._io.pos,ioOffset:this._io.byteOffset},this.blocksMapOffset=this._io.readU4le(),this._debug.blocksMapOffset.end=this._io.pos),this._parent.version.major>=1&&(this._debug.offsetData={start:this._io.pos,ioOffset:this._io.byteOffset},this.offsetData=this._io.readU4le(),this._debug.offsetData.end=this._io.pos),this._debug.geometry={start:this._io.pos,ioOffset:this._io.byteOffset},this.geometry=new a(this._io,this,this._root),this._debug.geometry.end=this._io.pos,this._parent.version.major>=1&&(this._debug.reserved1={start:this._io.pos,ioOffset:this._io.byteOffset},this.reserved1=this._io.readU4le(),this._debug.reserved1.end=this._io.pos),this._debug.diskSize={start:this._io.pos,ioOffset:this._io.byteOffset},this.diskSize=this._io.readU8le(),this._debug.diskSize.end=this._io.pos,this._debug.blockDataSize={start:this._io.pos,ioOffset:this._io.byteOffset},this.blockDataSize=this._io.readU4le(),this._debug.blockDataSize.end=this._io.pos,this._parent.version.major>=1&&(this._debug.blockMetadataSize={start:this._io.pos,ioOffset:this._io.byteOffset},this.blockMetadataSize=this._io.readU4le(),this._debug.blockMetadataSize.end=this._io.pos),this._debug.blocksInImage={start:this._io.pos,ioOffset:this._io.byteOffset},this.blocksInImage=this._io.readU4le(),this._debug.blocksInImage.end=this._io.pos,this._debug.blocksAllocated={start:this._io.pos,ioOffset:this._io.byteOffset},this.blocksAllocated=this._io.readU4le(),this._debug.blocksAllocated.end=this._io.pos,this._debug.uuidImage={start:this._io.pos,ioOffset:this._io.byteOffset},this.uuidImage=new t(this._io,this,this._root),this._debug.uuidImage.end=this._io.pos,this._debug.uuidLastSnap={start:this._io.pos,ioOffset:this._io.byteOffset},this.uuidLastSnap=new t(this._io,this,this._root),this._debug.uuidLastSnap.end=this._io.pos,this._debug.uuidLink={start:this._io.pos,ioOffset:this._io.byteOffset},this.uuidLink=new t(this._io,this,this._root),this._debug.uuidLink.end=this._io.pos,this._parent.version.major>=1&&(this._debug.uuidParent={start:this._io.pos,ioOffset:this._io.byteOffset},this.uuidParent=new t(this._io,this,this._root),this._debug.uuidParent.end=this._io.pos),this._parent.version.major>=1&&this._io.pos+16<=this._io.size&&(this._debug.lchcGeometry={start:this._io.pos,ioOffset:this._io.byteOffset},this.lchcGeometry=new a(this._io,this,this._root),this._debug.lchcGeometry.end=this._io.pos)};var s=e.Flags=(function(){function o(u,b,p){this._io=u,this._parent=b,this._root=p,this._debug={},this._read()}return o.prototype._read=function(){this._debug.reserved0={start:this._io.pos,ioOffset:this._io.byteOffset},this.reserved0=this._io.readBitsIntBe(15),this._debug.reserved0.end=this._io.pos,this._debug.zeroExpand={start:this._io.pos,ioOffset:this._io.byteOffset},this.zeroExpand=this._io.readBitsIntBe(1)!=0,this._debug.zeroExpand.end=this._io.pos,this._debug.reserved1={start:this._io.pos,ioOffset:this._io.byteOffset},this.reserved1=this._io.readBitsIntBe(6),this._debug.reserved1.end=this._io.pos,this._debug.diff={start:this._io.pos,ioOffset:this._io.byteOffset},this.diff=this._io.readBitsIntBe(1)!=0,this._debug.diff.end=this._io.pos,this._debug.fixed={start:this._io.pos,ioOffset:this._io.byteOffset},this.fixed=this._io.readBitsIntBe(1)!=0,this._debug.fixed.end=this._io.pos,this._debug.reserved2={start:this._io.pos,ioOffset:this._io.byteOffset},this.reserved2=this._io.readBitsIntBe(8),this._debug.reserved2.end=this._io.pos},o})(),a=e.Geometry=(function(){function o(u,b,p){this._io=u,this._parent=b,this._root=p,this._debug={},this._read()}return o.prototype._read=function(){this._debug.cylinders={start:this._io.pos,ioOffset:this._io.byteOffset},this.cylinders=this._io.readU4le(),this._debug.cylinders.end=this._io.pos,this._debug.heads={start:this._io.pos,ioOffset:this._io.byteOffset},this.heads=this._io.readU4le(),this._debug.heads.end=this._io.pos,this._debug.sectors={start:this._io.pos,ioOffset:this._io.byteOffset},this.sectors=this._io.readU4le(),this._debug.sectors.end=this._io.pos,this._debug.sectorSize={start:this._io.pos,ioOffset:this._io.byteOffset},this.sectorSize=this._io.readU4le(),this._debug.sectorSize.end=this._io.pos},o})();return e})(),t=i.Uuid=(function(){function e(s,a,o){this._io=s,this._parent=a,this._root=o,this._debug={},this._read()}return e.prototype._read=function(){this._debug.uuid={start:this._io.pos,ioOffset:this._io.byteOffset},this.uuid=this._io.readBytes(16),this._debug.uuid.end=this._io.pos},e})(),n=i.Version=(function(){function e(s,a,o){this._io=s,this._parent=a,this._root=o,this._debug={},this._read()}return e.prototype._read=function(){this._debug.major={start:this._io.pos,ioOffset:this._io.byteOffset},this.major=this._io.readU2le(),this._debug.major.end=this._io.pos,this._debug.minor={start:this._io.pos,ioOffset:this._io.byteOffset},this.minor=this._io.readU2le(),this._debug.minor.end=this._io.pos},e})();return Object.defineProperty(i.prototype,"blockSize",{get:function(){return this._m_blockSize!==void 0?this._m_blockSize:(this._debug._m_blockSize={},this._m_blockSize=this.headerMain.blockMetadataSize+this.headerMain.blockDataSize,this._m_blockSize)}}),Object.defineProperty(i.prototype,"blocksMapOffset",{get:function(){return this._m_blocksMapOffset!==void 0?this._m_blocksMapOffset:(this._debug._m_blocksMapOffset={},this._m_blocksMapOffset=this.headerMain.blocksMapOffset,this._m_blocksMapOffset)}}),Object.defineProperty(i.prototype,"blocksMapSize",{get:function(){return this._m_blocksMapSize!==void 0?this._m_blocksMapSize:(this._debug._m_blocksMapSize={},this._m_blocksMapSize=Math.floor((this.headerMain.blocksInImage*4+this.headerMain.geometry.sectorSize-1)/this.headerMain.geometry.sectorSize)*this.headerMain.geometry.sectorSize,this._m_blocksMapSize)}}),Object.defineProperty(i.prototype,"blocksOffset",{get:function(){return this._m_blocksOffset!==void 0?this._m_blocksOffset:(this._debug._m_blocksOffset={},this._m_blocksOffset=this.headerMain.offsetData,this._m_blocksOffset)}}),Object.defineProperty(i.prototype,"headerSize",{get:function(){return this._m_headerSize!==void 0?this._m_headerSize:(this._debug._m_headerSize={},this._m_headerSize=this.subheaderSizeIsDynamic?this.headerSizeOptional:336,this._m_headerSize)}}),Object.defineProperty(i.prototype,"subheaderSizeIsDynamic",{get:function(){return this._m_subheaderSizeIsDynamic!==void 0?this._m_subheaderSizeIsDynamic:(this._debug._m_subheaderSizeIsDynamic={},this._m_subheaderSizeIsDynamic=this.version.major>=1,this._m_subheaderSizeIsDynamic)}}),i})();return Object.defineProperty(h.prototype,"blockDiscarded",{get:function(){return this._m_blockDiscarded!==void 0?this._m_blockDiscarded:(this._debug._m_blockDiscarded={},this._m_blockDiscarded=4294967294,this._m_blockDiscarded)}}),Object.defineProperty(h.prototype,"blockUnallocated",{get:function(){return this._m_blockUnallocated!==void 0?this._m_blockUnallocated:(this._debug._m_blockUnallocated={},this._m_blockUnallocated=4294967295,this._m_blockUnallocated)}}),Object.defineProperty(h.prototype,"blocksMap",{get:function(){if(this._m_blocksMap!==void 0)return this._m_blocksMap;var i=this._io.pos;this._io.seek(this.header.blocksMapOffset),this._debug._m_blocksMap={start:this._io.pos,ioOffset:this._io.byteOffset},this._raw__m_blocksMap=this._io.readBytes(this.header.blocksMapSize);var d=new _(this._raw__m_blocksMap);return this._m_blocksMap=new l(d,this,this._root),this._debug._m_blocksMap.end=this._io.pos,this._io.seek(i),this._m_blocksMap}}),Object.defineProperty(h.prototype,"disk",{get:function(){if(this._m_disk!==void 0)return this._m_disk;var i=this._io.pos;return this._io.seek(this.header.blocksOffset),this._debug._m_disk={start:this._io.pos,ioOffset:this._io.byteOffset},this._m_disk=new g(this._io,this,this._root),this._debug._m_disk.end=this._io.pos,this._io.seek(i),this._m_disk}}),h})();r.Vdi=c})}});const S=z(),M={id:"vdi",title:"VirtualBox Disk Image",ksy:{meta:{id:"vdi",title:"VirtualBox Disk Image",application:["VirtualBox","QEMU","VMWare Workstation"],"file-extension":"vdi",xref:{justsolve:"VDI",forensicswiki:"virtual_disk_image_(vdi)",pronom:"fmt/726",wikidata:"Q29209126"},license:"GPL-3.0-or-later",encoding:"utf-8",endian:"le"},"doc-ref":"https://github.com/qemu/qemu/blob/master/block/vdi.c",doc:`A native VirtualBox file format

Images for testing can be downloaded from

 * <https://www.osboxes.org/virtualbox-images/>
 * <https://virtualboxes.org/images/>

or you can convert images of other formats.
`,seq:[{id:"header",type:"header"}],instances:{block_discarded:{value:"0xfffffffe"},block_unallocated:{value:"0xffffffff"},blocks_map:{"-orig-id":"bmap",pos:"header.blocks_map_offset",size:"header.blocks_map_size",type:"blocks_map",doc:`block_index = offset_in_virtual_disk / block_size actual_data_offset = blocks_map[block_index]*block_size+metadata_size+offset_in_block
The blocks_map will take up blocks_in_image_max * sizeof(uint32_t) bytes; since the blocks_map is read and written in a single operation, its size needs to be limited to INT_MAX; furthermore, when opening an image, the blocks_map size is rounded up to be aligned on BDRV_SECTOR_SIZE. Therefore this should satisfy the following: blocks_in_image_max * sizeof(uint32_t) + BDRV_SECTOR_SIZE == INT_MAX + 1 (INT_MAX + 1 is the first value not representable as an int) This guarantees that any value below or equal to the constant will, when multiplied by sizeof(uint32_t) and rounded up to a BDRV_SECTOR_SIZE boundary, still be below or equal to INT_MAX.
`},disk:{pos:"header.blocks_offset",type:"disk"}},types:{header:{seq:[{id:"text",type:"str",size:64},{id:"signature",contents:[127,16,218,190]},{id:"version",type:"version"},{id:"header_size_optional",type:"u4",if:"subheader_size_is_dynamic"},{id:"header_main",size:"header_size",type:"header_main"}],instances:{subheader_size_is_dynamic:{value:"version.major>=1"},header_size:{value:"(subheader_size_is_dynamic ? header_size_optional : 336)"},blocks_map_size:{value:"( ( header_main.blocks_in_image * 4 + header_main.geometry.sector_size - 1 ) / header_main.geometry.sector_size ) * header_main.geometry.sector_size"},blocks_map_offset:{value:"header_main.blocks_map_offset"},blocks_offset:{"-orig-id":"data_offset",value:"header_main.offset_data"},block_size:{value:"header_main.block_metadata_size + header_main.block_data_size"}},types:{uuid:{seq:[{id:"uuid",size:16}]},version:{seq:[{id:"major",type:"u2"},{id:"minor",type:"u2"}]},header_main:{seq:[{id:"image_type",type:"u4",enum:"image_type"},{id:"image_flags",type:"flags"},{id:"description",type:"str",size:256},{id:"blocks_map_offset","-orig-id":"offset_bmap",type:"u4",if:"_parent.version.major>=1"},{id:"offset_data",type:"u4",if:"_parent.version.major>=1"},{id:"geometry",type:"geometry"},{id:"reserved1","-orig-id":"unused1",type:"u4",if:"_parent.version.major>=1"},{id:"disk_size",type:"u8"},{id:"block_data_size","-orig-id":"block_size",type:"u4",doc:"Size of block (bytes)."},{id:"block_metadata_size","-orig-id":"block_extra",type:"u4",if:"_parent.version.major>=1"},{id:"blocks_in_image",type:"u4"},{id:"blocks_allocated",type:"u4"},{id:"uuid_image",type:"uuid"},{id:"uuid_last_snap",type:"uuid"},{id:"uuid_link",type:"uuid"},{id:"uuid_parent",type:"uuid",if:"_parent.version.major>=1"},{id:"lchc_geometry",type:"geometry",if:"_parent.version.major>=1 and _io.pos + 16 <= _io.size"}],types:{geometry:{seq:[{id:"cylinders",type:"u4"},{id:"heads",type:"u4"},{id:"sectors",type:"u4"},{id:"sector_size",type:"u4"}]},flags:{seq:[{id:"reserved0",type:"b15"},{id:"zero_expand",type:"b1"},{id:"reserved1",type:"b6"},{id:"diff",type:"b1"},{id:"fixed",type:"b1"},{id:"reserved2",type:"b8"}]}}}}},blocks_map:{seq:[{id:"index",type:"block_index",repeat:"expr","repeat-expr":"_root.header.header_main.blocks_in_image"}],types:{block_index:{seq:[{id:"index",type:"u4"}],instances:{is_allocated:{value:"index < _root.block_discarded"},block:{value:"_root.disk.blocks[index]",if:"is_allocated"}}}}},disk:{seq:[{id:"blocks",type:"block",repeat:"expr","repeat-expr":"_root.header.header_main.blocks_in_image"}],types:{block:{seq:[{id:"metadata",size:"_root.header.header_main.block_metadata_size"},{id:"data",size:"_root.header.header_main.block_data_size",type:"sector",repeat:"eos"}],types:{sector:{seq:[{id:"data",size:"_root.header.header_main.geometry.sector_size"}]}}}}}},enums:{image_type:{1:"dynamic",2:"static",3:"undo",4:"diff"}}}};export{S as default,M as spec};
